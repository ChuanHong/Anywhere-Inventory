//This function is bond to a trigger. The trigger setting can be found at menu > "Edit" > "Current project's triggers"
//The trigger-bond function will create a Google doc report based on the newly submitted form response, then save the doc into a pdf.

function genepdf() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var lastrow = sheet.getLastRow();
  var url = sheet.getFormUrl();

var form = FormApp.openByUrl(url);
  var formname = DriveApp.getFileById(form.getId()).getName();
  var formResponse = form.getResponses()[lastrow-2]; //This line of code makes sure only the latest response will be used to generate PDF.
  var timestamp = formResponse.getTimestamp();
  var checkedBoxes = formResponse.getItemResponses()[0].getResponse();
  var listResponse = formResponse.getItemResponses()[1].getResponse();
  var textsResponse = formResponse.getItemResponses()[2].getResponse();
  var imgResponse = formResponse.getItemResponses()[3].getResponse(); 
    var imgid = imgResponse.toString(); 
    var blob = DriveApp.getFileById(imgid).getBlob();
  
   var linkStyle = {};
     linkStyle[DocumentApp.Attribute.HORIZONTAL_ALIGNMENT] = DocumentApp.HorizontalAlignment.LEFT;
     linkStyle[DocumentApp.Attribute.LINK_URL] = true;
   var boldStyle = {};
      boldStyle[DocumentApp.Attribute.BOLD] = true;
  
  var doc = DocumentApp.create(formname);  
  var body = doc.getBody();
  var para1 = body.appendParagraph('Text1');
      para1.appendText(formname.toString());
      para1.getChild(1).asText().setAttributes(boldStyle);
      
  body.appendHorizontalRule();
  
  var para2 = body.appendParagraph('Text2');
      para2.appendText(timestamp.toString());
      para2.getChild(1).setAttributes(boldStyle);
      
  body.appendParagraph('Text3');
  var table = body.appendTable();
  var arrayprep = checkedboxes.toString();
  var checkedboxesarray = arrayprep.split(".,");
  var lastindex = checkedboxesarray.length;
  for (i=0; i<lastindex; i++){
    var rows = table.appendTableRow()
    var cells = rows.appendTableCell(checkedboxesarray[i]);
       }
  
  body.appendParagraph('Text4'+textsResponse);
  
 var para3 = body.appendParagraph('Text5A'+listResponse+'Text5B');
  var textBeforebold = "Text5A";
  var n = textBeforebold.length;
  var boldedpart = nameResponse.toString().length;
  para3.getChild(0).asText().setAttributes(n, boldedpart+n, boldStyle);
  
  var addimg = body.appendImage(blob);
      addimg.setHeight('256');
      addimg.setWidth('192');
  
  var parLink = body.appendParagraph('URL_display_text');
  parLink.setAttributes(linkStyle);
  parLink.setLinkUrl('URL_address');
  var urlimg = DriveApp.getFileById('icon_image_Id');
  var urlimgapp = parLink.insertInlineImage(0, urlimg);
      urlimgapp.setHeight('32');
      urlimgapp.setWidth('32');
  doc.saveAndClose();
  
  var docblob = doc.getAs('application/pdf');
  docblob.setName(doc.getName() + ".pdf");
  var pdfgen = DriveApp.createFile(docblob);
  
  var docid = doc.getId();
  var pdfid = pdfgen.getId();
  var filedoc = DriveApp.getFileById(docid);
  var filepdf = DriveApp.getFileById(pdfid);
  var folder = DriveApp.getFileById(form.getId()).getParents().next();
  folder.addFile(filepdf);
DriveApp.getRootFolder().removeFile(filedoc);
DriveApp.getRootFolder().removeFile(filepdf);
}
